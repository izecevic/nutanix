{
  "status": {
    "state": "ACTIVE",
    "message_list": [],
    "name": "Openldap_Install_Configure",
    "resources": {
      "project_reference_list": [
        {
          "kind": "project",
          "uuid": "d64d5488-1f58-423c-b176-5c8b871f25a4",
          "name": "alain_client1"
        }
      ],
      "type": "EXEC",
      "attrs": {
        "script_type": "static",
        "type": "",
        "command_line_args": "",
        "exit_status": [],
        "script": "#!/bin/sh\n\n#Variables used in this script\nSECOND_LEVEL_DOMAIN_NAME=\"@@{SECOND_LEVEL_DOMAIN_NAME}@@\"\nTOP_LEVEL_DOMAIN_NAME=\"@@{TOP_LEVEL_DOMAIN_NAME}@@\"\nOPENLDAP_PASSWORD=\"@@{OPENLDAP_PASSWORD}@@\"\nCERTIFICATE_COUNTRY=\"@@{CERTIFICATE_COUNTRY}@@\"\nCERTIFICATE_STATE=\"@@{CERTIFICATE_STATE}@@\"\nCERTIFICATE_CITY=\"@@{CERTIFICATE_CITY}@@\"\n\n#Yum update and upgrade\nsudo yum -y update\nsudo yum -y upgrade\n\n#Install required packages\nsudo yum -y install net-tools bind-utils bash-completion nano firewalld\nsudo echo \"yum updates completed!\" >> ~/status.txt\n\n#Set hostname\nsudo hostnamectl set-hostname openldap-host\nsudo echo \"hostname configured!\" >> ~/status.txt\n\n#Install openldap and required packages \nsudo yum -y install openldap compat-openldap openldap-clients openldap-servers openldap-servers-sql openldap-devel\nsudo echo \"openldap packages installed!\" >> ~/status.txt\n\n#Enable and start ldap service\nsudo systemctl start slapd.service\nsudo systemctl enable slapd.service\nsudo echo \"openldap services enabled and started!\" >> ~/status.txt\n\nsudo netstat -antup | grep -i 389 >> ~/status.txt\nsudo echo \"openldap status status - see above\" >> ~/status.txt\n\n#Install firewalld and enable and start the firewalld service\nsudo yum -y install firewalld\nsudo systemctl start firewalld\nsudo systemctl enable firewalld\n\n#Firewall config\nsudo firewall-cmd --permanent --add-service=ldap\nsudo firewall-cmd --reload\nsudo echo \"firewall configured!\" >> ~/status.txt\nsudo sed -i -- 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config\n\n#OpenLdap configiration\nsudo echo \"dn: olcDatabase={2}hdb,cn=config\nchangetype: modify\nreplace: olcSuffix\nolcSuffix: dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\n\ndn: olcDatabase={2}hdb,cn=config\nchangetype: modify\nreplace: olcRootDN\nolcRootDN: cn=ldapadm,dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\n\ndn: olcDatabase={2}hdb,cn=config\nchangetype: modify\nreplace: olcRootPW\" | tee ~/db.ldif\n\nsudo /usr/sbin/slappasswd -n -s ${OPENLDAP_PASSWORD} > ~/hash.txt\n\nsudo echo \"olcRootPW: `cat ~/hash.txt`\" >> ~/db.ldif\n\nsudo /usr/bin/ldapmodify -Y EXTERNAL  -H ldapi:/// -f ~/db.ldif\n\nsudo echo \"openldap configured!\" >> ~/status.txt\n\nsudo echo \"dn: olcDatabase={1}monitor,cn=config\nchangetype: modify\nreplace: olcAccess\nolcAccess: {0}to * by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external, cn=auth\" read by dn.base=\"cn=ldapadm,dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\" read by * none\n\" | tee ~/monitor.ldif\n\nsudo /usr/bin/ldapmodify -Y EXTERNAL  -H ldapi:/// -f ~/monitor.ldif\n\nsudo echo \"openldap restrict monitor access configured!\" >> ~/status.txt\n\nsudo /usr/bin/openssl req -new -x509 -subj \"/C=${CERTIFICATE_COUNTRY}/ST=${CERTIFICATE_STATE}/L=${CERTIFICATE_CITY}/CN=${SECOND_LEVEL_DOMAIN_NAME}.${TOP_LEVEL_DOMAIN_NAME}\" -nodes -out /etc/openldap/certs/${SECOND_LEVEL_DOMAIN_NAME}.pem -keyout /etc/openldap/certs/${SECOND_LEVEL_DOMAIN_NAME}.pem -days 365\nchown -R ldap:ldap /etc/openldap/certs/*.pem\nll /etc/openldap/certs/*.pem >> ~/status.txt\n\nsudo echo \"certificate created!\" >> ~/status.txt\n\nsudo echo \"dn: cn=config\nchangetype: modify\nreplace: olcTLSCertificateFile\nolcTLSCertificateFile: /etc/openldap/certs/${SECOND_LEVEL_DOMAIN_NAME}.pem\n\ndn: cn=config\nchangetype: modify\nreplace: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: /etc/openldap/certs/${SECOND_LEVEL_DOMAIN_NAME}.pem\" | tee ~/certs.ldif\n\nsudo /usr/bin/ldapmodify -Y EXTERNAL  -H ldapi:/// -f ~/certs.ldif\n\nsudo echo \"openldap secure communication configured!\" >> ~/status.txt\n\nsudo cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG\nsudo chown ldap:ldap /var/lib/ldap/*\n\nsudo /usr/bin/ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif\nsudo /usr/bin/ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif \nsudo /usr/bin/ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif\n\nsudo echo \"dn: dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\ndc: ${SECOND_LEVEL_DOMAIN_NAME}\nobjectClass: top\nobjectClass: domain\n\ndn: cn=ldapadm,dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\nobjectClass: organizationalRole\ncn: ldapadm\ndescription: LDAP Manager\n\ndn: ou=People,dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\nobjectClass: organizationalUnit\nou: People\n\ndn: ou=Group,dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\nobjectClass: organizationalUnit\nou: Group\n\" | tee ~/base.ldif\n\nsudo /usr/bin/ldapadd -x -w ${OPENLDAP_PASSWORD} -D \"cn=ldapadm,dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\" -f ~/base.ldif\n\nsudo echo \"openldap database setup!\" >> ~/status.txt\n\nsudo echo \"${TOP_LEVEL_DOMAIN_NAME}4.* /var/log/ldap.log\" >> /etc/rsyslog.conf\nsudo systemctl restart rsyslog\n\nsudo echo \"logging configured!\" >> ~/status.txt\n"
      },
      "variable_list": []
    },
    "description": ""
  },
  "spec": {
    "name": "Openldap_Install_Configure",
    "resources": {
      "type": "EXEC",
      "attrs": {
        "script": "#!/bin/sh\n\n#Variables used in this script\nSECOND_LEVEL_DOMAIN_NAME=\"@@{SECOND_LEVEL_DOMAIN_NAME}@@\"\nTOP_LEVEL_DOMAIN_NAME=\"@@{TOP_LEVEL_DOMAIN_NAME}@@\"\nOPENLDAP_PASSWORD=\"@@{OPENLDAP_PASSWORD}@@\"\nCERTIFICATE_COUNTRY=\"@@{CERTIFICATE_COUNTRY}@@\"\nCERTIFICATE_STATE=\"@@{CERTIFICATE_STATE}@@\"\nCERTIFICATE_CITY=\"@@{CERTIFICATE_CITY}@@\"\n\n#Yum update and upgrade\nsudo yum -y update\nsudo yum -y upgrade\n\n#Install required packages\nsudo yum -y install net-tools bind-utils bash-completion nano firewalld\nsudo echo \"yum updates completed!\" >> ~/status.txt\n\n#Set hostname\nsudo hostnamectl set-hostname openldap-host\nsudo echo \"hostname configured!\" >> ~/status.txt\n\n#Install openldap and required packages \nsudo yum -y install openldap compat-openldap openldap-clients openldap-servers openldap-servers-sql openldap-devel\nsudo echo \"openldap packages installed!\" >> ~/status.txt\n\n#Enable and start ldap service\nsudo systemctl start slapd.service\nsudo systemctl enable slapd.service\nsudo echo \"openldap services enabled and started!\" >> ~/status.txt\n\nsudo netstat -antup | grep -i 389 >> ~/status.txt\nsudo echo \"openldap status status - see above\" >> ~/status.txt\n\n#Install firewalld and enable and start the firewalld service\nsudo yum -y install firewalld\nsudo systemctl start firewalld\nsudo systemctl enable firewalld\n\n#Firewall config\nsudo firewall-cmd --permanent --add-service=ldap\nsudo firewall-cmd --reload\nsudo echo \"firewall configured!\" >> ~/status.txt\nsudo sed -i -- 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config\n\n#OpenLdap configiration\nsudo echo \"dn: olcDatabase={2}hdb,cn=config\nchangetype: modify\nreplace: olcSuffix\nolcSuffix: dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\n\ndn: olcDatabase={2}hdb,cn=config\nchangetype: modify\nreplace: olcRootDN\nolcRootDN: cn=ldapadm,dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\n\ndn: olcDatabase={2}hdb,cn=config\nchangetype: modify\nreplace: olcRootPW\" | tee ~/db.ldif\n\nsudo /usr/sbin/slappasswd -n -s ${OPENLDAP_PASSWORD} > ~/hash.txt\n\nsudo echo \"olcRootPW: `cat ~/hash.txt`\" >> ~/db.ldif\n\nsudo /usr/bin/ldapmodify -Y EXTERNAL  -H ldapi:/// -f ~/db.ldif\n\nsudo echo \"openldap configured!\" >> ~/status.txt\n\nsudo echo \"dn: olcDatabase={1}monitor,cn=config\nchangetype: modify\nreplace: olcAccess\nolcAccess: {0}to * by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external, cn=auth\" read by dn.base=\"cn=ldapadm,dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\" read by * none\n\" | tee ~/monitor.ldif\n\nsudo /usr/bin/ldapmodify -Y EXTERNAL  -H ldapi:/// -f ~/monitor.ldif\n\nsudo echo \"openldap restrict monitor access configured!\" >> ~/status.txt\n\nsudo /usr/bin/openssl req -new -x509 -subj \"/C=${CERTIFICATE_COUNTRY}/ST=${CERTIFICATE_STATE}/L=${CERTIFICATE_CITY}/CN=${SECOND_LEVEL_DOMAIN_NAME}.${TOP_LEVEL_DOMAIN_NAME}\" -nodes -out /etc/openldap/certs/${SECOND_LEVEL_DOMAIN_NAME}.pem -keyout /etc/openldap/certs/${SECOND_LEVEL_DOMAIN_NAME}.pem -days 365\nchown -R ldap:ldap /etc/openldap/certs/*.pem\nll /etc/openldap/certs/*.pem >> ~/status.txt\n\nsudo echo \"certificate created!\" >> ~/status.txt\n\nsudo echo \"dn: cn=config\nchangetype: modify\nreplace: olcTLSCertificateFile\nolcTLSCertificateFile: /etc/openldap/certs/${SECOND_LEVEL_DOMAIN_NAME}.pem\n\ndn: cn=config\nchangetype: modify\nreplace: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: /etc/openldap/certs/${SECOND_LEVEL_DOMAIN_NAME}.pem\" | tee ~/certs.ldif\n\nsudo /usr/bin/ldapmodify -Y EXTERNAL  -H ldapi:/// -f ~/certs.ldif\n\nsudo echo \"openldap secure communication configured!\" >> ~/status.txt\n\nsudo cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG\nsudo chown ldap:ldap /var/lib/ldap/*\n\nsudo /usr/bin/ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif\nsudo /usr/bin/ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif \nsudo /usr/bin/ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif\n\nsudo echo \"dn: dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\ndc: ${SECOND_LEVEL_DOMAIN_NAME}\nobjectClass: top\nobjectClass: domain\n\ndn: cn=ldapadm,dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\nobjectClass: organizationalRole\ncn: ldapadm\ndescription: LDAP Manager\n\ndn: ou=People,dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\nobjectClass: organizationalUnit\nou: People\n\ndn: ou=Group,dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\nobjectClass: organizationalUnit\nou: Group\n\" | tee ~/base.ldif\n\nsudo /usr/bin/ldapadd -x -w ${OPENLDAP_PASSWORD} -D \"cn=ldapadm,dc=${SECOND_LEVEL_DOMAIN_NAME},dc=${TOP_LEVEL_DOMAIN_NAME}\" -f ~/base.ldif\n\nsudo echo \"openldap database setup!\" >> ~/status.txt\n\nsudo echo \"${TOP_LEVEL_DOMAIN_NAME}4.* /var/log/ldap.log\" >> /etc/rsyslog.conf\nsudo systemctl restart rsyslog\n\nsudo echo \"logging configured!\" >> ~/status.txt\n",
        "script_type": "static"
      },
      "variable_list": []
    },
    "description": ""
  },
  "api_version": "3.0",
  "metadata": {
    "last_update_time": "1672150074223563",
    "kind": "app_task",
    "uuid": "b21b0c12-1efc-42bd-b4d7-d01d3b41ade4",
    "owner_reference": {
      "kind": "user",
      "uuid": "f770294b-960c-5b8d-9e5b-1441b339aff7",
      "name": "alain.veuve@emeagso.lab"
    },
    "spec_version": 0,
    "creation_time": "1672150074223563",
    "name": "Openldap_Install_Configure"
  }
}
