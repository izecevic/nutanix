{
  "status": {
    "state": "ACTIVE",
    "message_list": [],
    "name": "DataSet_Install_and_Configure",
    "resources": {
      "project_reference_list": [
        {
          "kind": "project",
          "uuid": "d64d5488-1f58-423c-b176-5c8b871f25a4",
          "name": "alain_client1"
        }
      ],
      "type": "EXEC",
      "attrs": {
        "script_type": "static",
        "type": "",
        "command_line_args": "",
        "exit_status": [],
        "script": "#!/bin/bash\nset -ex\n\n##  Variable Initialization\nPROFILE=\"@@{PROFILE}@@\"\nVERSION=\"@@{MONGO_VERSION}@@\"\nDATA_PATH=\"@@{DATA_PATH}@@\"\nJOURNAL_PATH=\"@@{JOURNAL_PATH}@@\"\nLOG_PATH=\"@@{LOG_PATH}@@\"\n\n\n## Set hostname\nsudo hostnamectl set-hostname --static @@{name}@@\n\n\n## Getting data ip and router ip addresses\nif [ \"x${PROFILE}\" = \"xAHV\" ]\nthen\n\tDATA_IP_LIST=\"@@{calm_array_address}@@\"\n  CONFIG_IP_LIST=\"@@{AHVConfigSet.address}@@\"\n  ROUTER_IP_LIST=\"@@{AHVRouter.address}@@\"\n  REPLICA_IPS=\"@@{calm_array_address}@@\"\n\tINTERNAL_IP=\"@@{address}@@\"\nelif [ \"x${PROFILE}\" = \"xAWS\" ]\nthen\n\tDATA_IP_LIST=\"@@{calm_array_private_ip_address}@@\"\n  CONFIG_IP_LIST=\"@@{AWSConfigSet.private_ip_address}@@\"\n  ROUTER_IP_LIST=\"@@{AWSRouter.private_ip_address}@@\"\n  REPLICA_IPS=\"@@{calm_array_private_ip_address}@@\"\n\tINTERNAL_IP=\"@@{private_ip_address}@@\"\nelif [ \"x${PROFILE}\" = \"xGCP\" ]\nthen\n\tDATA_IP_LIST=\"@@{calm_array_private_ip_address}@@\"\n  CONFIG_IP_LIST=\"@@{GCPConfigSet.private_ip_address}@@\"\n  ROUTER_IP_LIST=\"@@{GCPRouter.private_ip_address}@@\" \n  REPLICA_IPS=\"@@{calm_array_private_ip_address}@@\"\n\tINTERNAL_IP=\"@@{private_ip_address}@@\"    \nelif [ \"x${PROFILE}\" = \"xAZURE\" ]\nthen\n\tDATA_IP_LIST=\"@@{calm_array_private_ip_address}@@\"\n  CONFIG_IP_LIST=\"@@{AzureConfigSet.private_ip_address}@@\"\n  ROUTER_IP_LIST=\"@@{AzureRouter.private_ip_address}@@\"  \n  REPLICA_IPS=\"@@{calm_array_private_ip_address}@@\"\n\tINTERNAL_IP=\"@@{private_ip_address}@@\"    \n    \nelif [ \"x${PROFILE}\" = \"xVMWARE\" ]\nthen\n\tDATA_IP_LIST=\"@@{calm_array_address}@@\"\n  CONFIG_IP_LIST=\"@@{VMwareConfigSet.address}@@\"\n  ROUTER_IP_LIST=\"@@{VMwareRouter.address}@@\"  \n  REPLICA_IPS=\"@@{calm_array_address}@@\"\n\tINTERNAL_IP=\"@@{address}@@\"\nfi\n\n## Evalaute extra vars \nINDEX=@@{calm_array_index}@@\nNODES_PER_REPLICA_SET=@@{NODES_PER_REPLICA_SET}@@\nARRAY_REPLICA_IPS=$(echo ${REPLICA_IPS} | sed 's/^,//' | sed 's/,$//' | tr \",\" \"\\n\")\n\ntmp=$((${INDEX}+${NODES_PER_REPLICA_SET}))\nreplicasetNo=$((${tmp}/${NODES_PER_REPLICA_SET}))\nreplicaSetName=\"dataReplSet${replicasetNo}\"\n\n\n## Update hosts file \ncat > /tmp/set-hostnames.py <<EOF\n#!/usr/bin/python\nimport re\nconfig_ips=\"${CONFIG_IP_LIST}\"\ndata_ips=\"${DATA_IP_LIST}\"\nrouter_ips=\"${ROUTER_IP_LIST}\"\n\nhostfile = open('/etc/hosts', 'r').read()\nprint hostfile\nhostfile = re.sub('\\n#MONGODB-BEGIN.*?#MONGODB-END', '', hostfile, flags=re.DOTALL)\nhostfile += \"#MONGODB-BEGIN\\n\"\ncount=1\nfor ip in config_ips.split(','):\n  hostfile += ip + \" config\" + str(count) + \".mongodb\\n\"\n  count += 1\ncount=1\nfor ip in data_ips.split(','):\n  hostfile += ip + \" data\" + str(count) + \".mongodb\\n\"\n  count += 1\ncount=1\nfor ip in router_ips.split(','):\n  hostfile += ip + \" router\" + str(count) + \".mongodb\\n\"\n  count += 1\nhostfile += \"#MONGODB-END\\n\"\nopen('/etc/hosts', 'w').write(hostfile)\nEOF\n\nsudo python /tmp/set-hostnames.py\n\n## Configure mongod yum repo\necho '[mongodb-org-3.4]\nname=MongoDB Repository\nbaseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/\ngpgcheck=1\nenabled=1\ngpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc' | sudo tee /etc/yum.repos.d/mongodb-3.4.repo\n\n## Install mongoDB\nsudo yum install -y --quiet mongodb-org-${VERSION} mongodb-org-server-${VERSION} mongodb-org-shell-${VERSION} mongodb-org-mongos-${VERSION} mongodb-org-tools-${VERSION}\n\necho 'exclude=mongodb-org*' | sudo tee -a /etc/yum.conf\nsudo mkdir -p ${DATA_PATH} ${JOURNAL_PATH} ${LOG_PATH}\n\n## Mount mongo LVM partitions\necho \"/dev/mongoDataVG/mongoDataLV  ${DATA_PATH} xfs defaults,auto,noatime,noexec 0 0\n/dev/mongoJournalVG/mongoJournalLV ${JOURNAL_PATH} xfs defaults,auto,noexec 0 0\n/dev/mongoLogVG/mongoLogLV ${LOG_PATH} xfs defaults,auto,noexec 0 0\" | sudo tee -a /etc/fstab\nsudo mount -a\n\nsudo ln -s ${JOURNAL_PATH} ${DATA_PATH}/journal\nsudo chown -R mongod:mongod ${DATA_PATH} ${JOURNAL_PATH} ${LOG_PATH}\n\nsudo blockdev --setra 32 /dev/dm-2\nsudo blockdev --getra /dev/dm-2\n\n## Setup system params\nsudo sysctl vm.swappiness=1\necho 'vm.swappiness=1' | sudo tee -a /etc/sysctl.conf\n\n## Configure mongod conf\nsudo sed -i 's/bindIp:/#bindIp:/g' /etc/mongod.conf\nsudo sed -i \"s#/var/lib/mongo#${DATA_PATH}#g\" /etc/mongod.conf\nsudo sed -i \"s/#replication:/replication:\\n  replSetName: $replicaSetName/g\" /etc/mongod.conf\nsudo sed -i 's/#sharding:/sharding:\\n  clusterRole: shardsvr/g' /etc/mongod.conf\nsudo sed -i 's#  path: /var/log/mongodb/mongod.log#  path: /mongodb/log/mongod.log#' /etc/mongod.conf\n\n## Getting replicaset members details \nreplica_cnt=0\ndeclare -a replicaset_members\n\nfor replica in $ARRAY_REPLICA_IPS\ndo\n  tmp=$((${replica_cnt}+${NODES_PER_REPLICA_SET}))\n  i=\"$((${tmp}/${NODES_PER_REPLICA_SET}))\"\n  replicaset_members[$i]=${replicaset_members[$i]}\"{\\\"_id\\\": $replica_cnt, host:\\\"$replica:27017\\\"},\"\n  replica_cnt=$(($replica_cnt + 1))\ndone\n\nif [[ -f /sys/kernel/mm/transparent_hugepage/enabled ]];then\n\techo never | sudo tee /sys/kernel/mm/transparent_hugepage/enabled\nfi\nif [[ -f /sys/kernel/mm/transparent_hugepage/defrag ]];then\n\techo never | sudo tee /sys/kernel/mm/transparent_hugepage/defrag\nfi\n\nsudo systemctl restart mongod\nsudo systemctl enable mongod\nsleep 15\n\n### Initiating replicaset \njson=$(cat <<EOF\n{\n  \"_id\": \"$replicaSetName\",\n  \"members\": [ ${replicaset_members[$replicasetNo]}]\n}\nEOF\n)\nsudo mongo --host ${INTERNAL_IP} --port 27017 --eval \"rs.initiate( $json )\"\nsleep 2\n\n"
      },
      "variable_list": []
    },
    "description": ""
  },
  "spec": {
    "name": "DataSet_Install_and_Configure",
    "resources": {
      "type": "EXEC",
      "attrs": {
        "script": "#!/bin/bash\nset -ex\n\n##  Variable Initialization\nPROFILE=\"@@{PROFILE}@@\"\nVERSION=\"@@{MONGO_VERSION}@@\"\nDATA_PATH=\"@@{DATA_PATH}@@\"\nJOURNAL_PATH=\"@@{JOURNAL_PATH}@@\"\nLOG_PATH=\"@@{LOG_PATH}@@\"\n\n\n## Set hostname\nsudo hostnamectl set-hostname --static @@{name}@@\n\n\n## Getting data ip and router ip addresses\nif [ \"x${PROFILE}\" = \"xAHV\" ]\nthen\n\tDATA_IP_LIST=\"@@{calm_array_address}@@\"\n  CONFIG_IP_LIST=\"@@{AHVConfigSet.address}@@\"\n  ROUTER_IP_LIST=\"@@{AHVRouter.address}@@\"\n  REPLICA_IPS=\"@@{calm_array_address}@@\"\n\tINTERNAL_IP=\"@@{address}@@\"\nelif [ \"x${PROFILE}\" = \"xAWS\" ]\nthen\n\tDATA_IP_LIST=\"@@{calm_array_private_ip_address}@@\"\n  CONFIG_IP_LIST=\"@@{AWSConfigSet.private_ip_address}@@\"\n  ROUTER_IP_LIST=\"@@{AWSRouter.private_ip_address}@@\"\n  REPLICA_IPS=\"@@{calm_array_private_ip_address}@@\"\n\tINTERNAL_IP=\"@@{private_ip_address}@@\"\nelif [ \"x${PROFILE}\" = \"xGCP\" ]\nthen\n\tDATA_IP_LIST=\"@@{calm_array_private_ip_address}@@\"\n  CONFIG_IP_LIST=\"@@{GCPConfigSet.private_ip_address}@@\"\n  ROUTER_IP_LIST=\"@@{GCPRouter.private_ip_address}@@\" \n  REPLICA_IPS=\"@@{calm_array_private_ip_address}@@\"\n\tINTERNAL_IP=\"@@{private_ip_address}@@\"    \nelif [ \"x${PROFILE}\" = \"xAZURE\" ]\nthen\n\tDATA_IP_LIST=\"@@{calm_array_private_ip_address}@@\"\n  CONFIG_IP_LIST=\"@@{AzureConfigSet.private_ip_address}@@\"\n  ROUTER_IP_LIST=\"@@{AzureRouter.private_ip_address}@@\"  \n  REPLICA_IPS=\"@@{calm_array_private_ip_address}@@\"\n\tINTERNAL_IP=\"@@{private_ip_address}@@\"    \n    \nelif [ \"x${PROFILE}\" = \"xVMWARE\" ]\nthen\n\tDATA_IP_LIST=\"@@{calm_array_address}@@\"\n  CONFIG_IP_LIST=\"@@{VMwareConfigSet.address}@@\"\n  ROUTER_IP_LIST=\"@@{VMwareRouter.address}@@\"  \n  REPLICA_IPS=\"@@{calm_array_address}@@\"\n\tINTERNAL_IP=\"@@{address}@@\"\nfi\n\n## Evalaute extra vars \nINDEX=@@{calm_array_index}@@\nNODES_PER_REPLICA_SET=@@{NODES_PER_REPLICA_SET}@@\nARRAY_REPLICA_IPS=$(echo ${REPLICA_IPS} | sed 's/^,//' | sed 's/,$//' | tr \",\" \"\\n\")\n\ntmp=$((${INDEX}+${NODES_PER_REPLICA_SET}))\nreplicasetNo=$((${tmp}/${NODES_PER_REPLICA_SET}))\nreplicaSetName=\"dataReplSet${replicasetNo}\"\n\n\n## Update hosts file \ncat > /tmp/set-hostnames.py <<EOF\n#!/usr/bin/python\nimport re\nconfig_ips=\"${CONFIG_IP_LIST}\"\ndata_ips=\"${DATA_IP_LIST}\"\nrouter_ips=\"${ROUTER_IP_LIST}\"\n\nhostfile = open('/etc/hosts', 'r').read()\nprint hostfile\nhostfile = re.sub('\\n#MONGODB-BEGIN.*?#MONGODB-END', '', hostfile, flags=re.DOTALL)\nhostfile += \"#MONGODB-BEGIN\\n\"\ncount=1\nfor ip in config_ips.split(','):\n  hostfile += ip + \" config\" + str(count) + \".mongodb\\n\"\n  count += 1\ncount=1\nfor ip in data_ips.split(','):\n  hostfile += ip + \" data\" + str(count) + \".mongodb\\n\"\n  count += 1\ncount=1\nfor ip in router_ips.split(','):\n  hostfile += ip + \" router\" + str(count) + \".mongodb\\n\"\n  count += 1\nhostfile += \"#MONGODB-END\\n\"\nopen('/etc/hosts', 'w').write(hostfile)\nEOF\n\nsudo python /tmp/set-hostnames.py\n\n## Configure mongod yum repo\necho '[mongodb-org-3.4]\nname=MongoDB Repository\nbaseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/\ngpgcheck=1\nenabled=1\ngpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc' | sudo tee /etc/yum.repos.d/mongodb-3.4.repo\n\n## Install mongoDB\nsudo yum install -y --quiet mongodb-org-${VERSION} mongodb-org-server-${VERSION} mongodb-org-shell-${VERSION} mongodb-org-mongos-${VERSION} mongodb-org-tools-${VERSION}\n\necho 'exclude=mongodb-org*' | sudo tee -a /etc/yum.conf\nsudo mkdir -p ${DATA_PATH} ${JOURNAL_PATH} ${LOG_PATH}\n\n## Mount mongo LVM partitions\necho \"/dev/mongoDataVG/mongoDataLV  ${DATA_PATH} xfs defaults,auto,noatime,noexec 0 0\n/dev/mongoJournalVG/mongoJournalLV ${JOURNAL_PATH} xfs defaults,auto,noexec 0 0\n/dev/mongoLogVG/mongoLogLV ${LOG_PATH} xfs defaults,auto,noexec 0 0\" | sudo tee -a /etc/fstab\nsudo mount -a\n\nsudo ln -s ${JOURNAL_PATH} ${DATA_PATH}/journal\nsudo chown -R mongod:mongod ${DATA_PATH} ${JOURNAL_PATH} ${LOG_PATH}\n\nsudo blockdev --setra 32 /dev/dm-2\nsudo blockdev --getra /dev/dm-2\n\n## Setup system params\nsudo sysctl vm.swappiness=1\necho 'vm.swappiness=1' | sudo tee -a /etc/sysctl.conf\n\n## Configure mongod conf\nsudo sed -i 's/bindIp:/#bindIp:/g' /etc/mongod.conf\nsudo sed -i \"s#/var/lib/mongo#${DATA_PATH}#g\" /etc/mongod.conf\nsudo sed -i \"s/#replication:/replication:\\n  replSetName: $replicaSetName/g\" /etc/mongod.conf\nsudo sed -i 's/#sharding:/sharding:\\n  clusterRole: shardsvr/g' /etc/mongod.conf\nsudo sed -i 's#  path: /var/log/mongodb/mongod.log#  path: /mongodb/log/mongod.log#' /etc/mongod.conf\n\n## Getting replicaset members details \nreplica_cnt=0\ndeclare -a replicaset_members\n\nfor replica in $ARRAY_REPLICA_IPS\ndo\n  tmp=$((${replica_cnt}+${NODES_PER_REPLICA_SET}))\n  i=\"$((${tmp}/${NODES_PER_REPLICA_SET}))\"\n  replicaset_members[$i]=${replicaset_members[$i]}\"{\\\"_id\\\": $replica_cnt, host:\\\"$replica:27017\\\"},\"\n  replica_cnt=$(($replica_cnt + 1))\ndone\n\nif [[ -f /sys/kernel/mm/transparent_hugepage/enabled ]];then\n\techo never | sudo tee /sys/kernel/mm/transparent_hugepage/enabled\nfi\nif [[ -f /sys/kernel/mm/transparent_hugepage/defrag ]];then\n\techo never | sudo tee /sys/kernel/mm/transparent_hugepage/defrag\nfi\n\nsudo systemctl restart mongod\nsudo systemctl enable mongod\nsleep 15\n\n### Initiating replicaset \njson=$(cat <<EOF\n{\n  \"_id\": \"$replicaSetName\",\n  \"members\": [ ${replicaset_members[$replicasetNo]}]\n}\nEOF\n)\nsudo mongo --host ${INTERNAL_IP} --port 27017 --eval \"rs.initiate( $json )\"\nsleep 2\n\n",
        "script_type": "static"
      },
      "variable_list": []
    },
    "description": ""
  },
  "api_version": "3.0",
  "metadata": {
    "last_update_time": "1672150032152458",
    "kind": "app_task",
    "uuid": "e40a80ae-a52b-4d44-a52c-27bd8bdbe3e7",
    "owner_reference": {
      "kind": "user",
      "uuid": "f770294b-960c-5b8d-9e5b-1441b339aff7",
      "name": "alain.veuve@emeagso.lab"
    },
    "spec_version": 0,
    "creation_time": "1672150032152458",
    "name": "DataSet_Install_and_Configure"
  }
}
