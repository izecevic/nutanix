{
  "status": {
    "state": "ACTIVE",
    "message_list": [],
    "name": "PcVmsListPost",
    "resources": {
      "project_reference_list": [
        {
          "kind": "project",
          "uuid": "d64d5488-1f58-423c-b176-5c8b871f25a4",
          "name": "alain_client1"
        }
      ],
      "type": "EXEC",
      "attrs": {
        "script_type": "npsscript",
        "type": "",
        "command_line_args": "",
        "exit_status": [],
        "script": "#region headers\n# posh-api-template v20190523 / stephane.bourdeaud@nutanix.com\n# ! Meant to be edited in VSCode w/ the BetterComments extension installed\n# ! Do NOT delete comments from this script!\n\n# * Conventions:\n# * Aiming for the the following standards:\n# * https://github.com/PoshCode/PowerShellPracticeAndStyle\n# * Otherwise use PEP8 when in doubt (https://pep8.org/)\n# 1. use all lower case for variable names.\n# 2. when composing variable names, use underscore to separate words. \n#    Exp: username_secret. Use this same convention in Calm.\n# 3. name sections with comments, comment line after the code.\n# 4. don't print secrets, including tokens. Favor authentication \n#    (login/logout) in each script.\n# 5. when saving your script, name it as the task name appears in Calm,\n#    using the following convention: NameOfIntegrationPoint-Verb-Text.ps1\n# 6. use double quotes first, then single quotes.\n# 7. Try your best and keep line length under 80 characters, even though\n#    it makes your eyes bleed.\n\n# TODO Deal with more than 20 returned entities\n# author:    stephane.bourdeaud@nutanix.com\n# version:   23/05/2019: initial tested version (Calm 2.6.0.3)\n# task_name: PcVmsListPost\n#endregion\n\n#region capture Calm variables\n# * Capture variables here. This makes sure Calm macros are not referenced \n# * anywhere else in order to improve maintainability.\n$username = '@@{prism_api_user.username}@@'\n$username_secret = \"@@{prism_api_user.secret}@@\"\n$api_server = \"@@{prism_ip}@@\"\n#endregion\n\n#region prepare api call\n$api_server_port = \"9440\"\n$api_server_endpoint = \"/api/nutanix/v3/vms/list\"\n$url = \"https://{0}:{1}{2}\" -f $api_server,$api_server_port, `\n    $api_server_endpoint\n$method = \"POST\"\n$headers = @{\n    \"Authorization\" = \"Basic \"+[System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($username+\":\"+$username_secret));\n    \"Content-Type\"=\"application/json\";\n    \"Accept\"=\"application/json\"\n}\n$length=100 #this specifies how many entities we want in the results of each API query\n\n\n# this is used to capture the content of the payload\n$content = @{\n    kind=\"vm\";\n    offset=0;\n    length=$length\n}\n$payload = (ConvertTo-Json $content -Depth 4)\n\n    \n# ignore SSL warnings\nWrite-Host \"$(Get-Date) [INFO] Ignoring invalid certificates\"\nif (-not ([System.Management.Automation.PSTypeName]'ServerCertificateValidationCallback').Type) {\n    $certCallback = @\"\n    using System;\n    using System.Net;\n    using System.Net.Security;\n    using System.Security.Cryptography.X509Certificates;\n    public class ServerCertificateValidationCallback\n    {\n        public static void Ignore()\n        {\n            if(ServicePointManager.ServerCertificateValidationCallback ==null)\n            {\n                ServicePointManager.ServerCertificateValidationCallback += \n                    delegate\n                    (\n                        Object obj, \n                        X509Certificate certificate, \n                        X509Chain chain, \n                        SslPolicyErrors errors\n                    )\n                    {\n                        return true;\n                    };\n            }\n        }\n    }\n\"@\n    Add-Type $certCallback\n}\n[ServerCertificateValidationCallback]::Ignore()\n\n# add Tls12 support\nWrite-Host \"$(Get-Date) [INFO] Adding Tls12 support\"\n[Net.ServicePointManager]::SecurityProtocol = `\n    ([Net.ServicePointManager]::SecurityProtocol -bor `\n    [Net.SecurityProtocolType]::Tls12)\n#endregion\n\n#region make api call\nWrite-Host \"$(Get-Date) [INFO] Making a $method call to $url\"\nDo {\n    try {\n        $resp = Invoke-RestMethod -Method $method -Uri $url -Headers $headers `\n            -Body $payload -ErrorAction Stop\n        Write-Host \"$(Get-Date) [INFO] Processing results from $($resp.metadata.offset) to $($resp.metadata.offset + $resp.metadata.length)\"\n        Write-Host \"$(Get-Date) [INFO] Response Metadata: $($resp.metadata | ConvertTo-Json)\"\n        # response data will be an array in $resp.entities\n        Write-Host \"$(Get-Date) [INFO] Showing entities in response:\"\n        ForEach ($entity in $resp.entities) {\n            $entity | Format-List #expose the data structure of entities\n        }\n        #prepare the json payload for the next batch of entities/response\n        $content = @{\n            kind=\"vm\";\n            offset=($resp.metadata.length + $resp.metadata.offset);\n            length=$length\n        }\n        $payload = (ConvertTo-Json $content -Depth 4)\n    }\n    catch {\n        $saved_error = $_.Exception.Message\n        # Write-Host \"$(Get-Date) [INFO] Headers: $($headers | ConvertTo-Json)\"\n        Write-Host \"$(Get-Date) [INFO] Payload: $payload\"\n        Throw \"$(get-date) [ERROR] $saved_error\"\n    }\n    finally {\n        #add any last words here; this gets processed no matter what\n    }\n}\nWhile ($resp.metadata.length -eq $length)\n#endregion"
      },
      "variable_list": []
    },
    "description": ""
  },
  "spec": {
    "name": "PcVmsListPost",
    "resources": {
      "type": "EXEC",
      "attrs": {
        "script": "#region headers\n# posh-api-template v20190523 / stephane.bourdeaud@nutanix.com\n# ! Meant to be edited in VSCode w/ the BetterComments extension installed\n# ! Do NOT delete comments from this script!\n\n# * Conventions:\n# * Aiming for the the following standards:\n# * https://github.com/PoshCode/PowerShellPracticeAndStyle\n# * Otherwise use PEP8 when in doubt (https://pep8.org/)\n# 1. use all lower case for variable names.\n# 2. when composing variable names, use underscore to separate words. \n#    Exp: username_secret. Use this same convention in Calm.\n# 3. name sections with comments, comment line after the code.\n# 4. don't print secrets, including tokens. Favor authentication \n#    (login/logout) in each script.\n# 5. when saving your script, name it as the task name appears in Calm,\n#    using the following convention: NameOfIntegrationPoint-Verb-Text.ps1\n# 6. use double quotes first, then single quotes.\n# 7. Try your best and keep line length under 80 characters, even though\n#    it makes your eyes bleed.\n\n# TODO Deal with more than 20 returned entities\n# author:    stephane.bourdeaud@nutanix.com\n# version:   23/05/2019: initial tested version (Calm 2.6.0.3)\n# task_name: PcVmsListPost\n#endregion\n\n#region capture Calm variables\n# * Capture variables here. This makes sure Calm macros are not referenced \n# * anywhere else in order to improve maintainability.\n$username = '@@{prism_api_user.username}@@'\n$username_secret = \"@@{prism_api_user.secret}@@\"\n$api_server = \"@@{prism_ip}@@\"\n#endregion\n\n#region prepare api call\n$api_server_port = \"9440\"\n$api_server_endpoint = \"/api/nutanix/v3/vms/list\"\n$url = \"https://{0}:{1}{2}\" -f $api_server,$api_server_port, `\n    $api_server_endpoint\n$method = \"POST\"\n$headers = @{\n    \"Authorization\" = \"Basic \"+[System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($username+\":\"+$username_secret));\n    \"Content-Type\"=\"application/json\";\n    \"Accept\"=\"application/json\"\n}\n$length=100 #this specifies how many entities we want in the results of each API query\n\n\n# this is used to capture the content of the payload\n$content = @{\n    kind=\"vm\";\n    offset=0;\n    length=$length\n}\n$payload = (ConvertTo-Json $content -Depth 4)\n\n    \n# ignore SSL warnings\nWrite-Host \"$(Get-Date) [INFO] Ignoring invalid certificates\"\nif (-not ([System.Management.Automation.PSTypeName]'ServerCertificateValidationCallback').Type) {\n    $certCallback = @\"\n    using System;\n    using System.Net;\n    using System.Net.Security;\n    using System.Security.Cryptography.X509Certificates;\n    public class ServerCertificateValidationCallback\n    {\n        public static void Ignore()\n        {\n            if(ServicePointManager.ServerCertificateValidationCallback ==null)\n            {\n                ServicePointManager.ServerCertificateValidationCallback += \n                    delegate\n                    (\n                        Object obj, \n                        X509Certificate certificate, \n                        X509Chain chain, \n                        SslPolicyErrors errors\n                    )\n                    {\n                        return true;\n                    };\n            }\n        }\n    }\n\"@\n    Add-Type $certCallback\n}\n[ServerCertificateValidationCallback]::Ignore()\n\n# add Tls12 support\nWrite-Host \"$(Get-Date) [INFO] Adding Tls12 support\"\n[Net.ServicePointManager]::SecurityProtocol = `\n    ([Net.ServicePointManager]::SecurityProtocol -bor `\n    [Net.SecurityProtocolType]::Tls12)\n#endregion\n\n#region make api call\nWrite-Host \"$(Get-Date) [INFO] Making a $method call to $url\"\nDo {\n    try {\n        $resp = Invoke-RestMethod -Method $method -Uri $url -Headers $headers `\n            -Body $payload -ErrorAction Stop\n        Write-Host \"$(Get-Date) [INFO] Processing results from $($resp.metadata.offset) to $($resp.metadata.offset + $resp.metadata.length)\"\n        Write-Host \"$(Get-Date) [INFO] Response Metadata: $($resp.metadata | ConvertTo-Json)\"\n        # response data will be an array in $resp.entities\n        Write-Host \"$(Get-Date) [INFO] Showing entities in response:\"\n        ForEach ($entity in $resp.entities) {\n            $entity | Format-List #expose the data structure of entities\n        }\n        #prepare the json payload for the next batch of entities/response\n        $content = @{\n            kind=\"vm\";\n            offset=($resp.metadata.length + $resp.metadata.offset);\n            length=$length\n        }\n        $payload = (ConvertTo-Json $content -Depth 4)\n    }\n    catch {\n        $saved_error = $_.Exception.Message\n        # Write-Host \"$(Get-Date) [INFO] Headers: $($headers | ConvertTo-Json)\"\n        Write-Host \"$(Get-Date) [INFO] Payload: $payload\"\n        Throw \"$(get-date) [ERROR] $saved_error\"\n    }\n    finally {\n        #add any last words here; this gets processed no matter what\n    }\n}\nWhile ($resp.metadata.length -eq $length)\n#endregion",
        "script_type": "npsscript"
      },
      "variable_list": []
    },
    "description": ""
  },
  "api_version": "3.0",
  "metadata": {
    "last_update_time": "1672150302436759",
    "kind": "app_task",
    "uuid": "48923fa4-266b-4cb0-8308-f7ae11f4339a",
    "owner_reference": {
      "kind": "user",
      "uuid": "f770294b-960c-5b8d-9e5b-1441b339aff7",
      "name": "alain.veuve@emeagso.lab"
    },
    "spec_version": 0,
    "creation_time": "1672150302436759",
    "name": "PcVmsListPost"
  }
}
