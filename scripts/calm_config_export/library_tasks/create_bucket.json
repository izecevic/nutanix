{
  "status": {
    "state": "ACTIVE",
    "message_list": [],
    "name": "create_bucket",
    "resources": {
      "project_reference_list": [
        {
          "kind": "project",
          "uuid": "d64d5488-1f58-423c-b176-5c8b871f25a4",
          "name": "alain_client1"
        }
      ],
      "type": "EXEC",
      "attrs": {
        "script_type": "static",
        "type": "",
        "command_line_args": "",
        "exit_status": [],
        "script": "import requests\nimport json\nimport re\nimport time\nimport sys\nfrom requests.packages.urllib3.exceptions import InsecureRequestWarning\n\nrequests.packages.urllib3.disable_warnings(InsecureRequestWarning)\n\npcip = \"10.0.0.1\"\nUSER_NAME = \"admin\"\nPASSWORD = \"xxxxxxx\"\n\nBASE_URL = \"https://\"+pcip+\":9440\"\nVERSIONING_FEATURE = \"VERSIONING\"\n\nobject_store_uuid = \"a646eee3-0c43-4a09-5205-bb9525a8d4a5\"\nbucket_name = \"calm-objects-bucket5\"\nenable_versioning = False\nnon_current_version_expiration = None #days\nexpiration = None #days\n\nclass RestUtilException(Exception):\n    pass\n\ndef _wrap(resp):\n    if resp.status_code in [200, 202]:\n        return resp.json()\n    else:\n        try:\n            resp_json = resp.json()\n            if 'message_list' in resp_json:\n                raise RestUtilException(\"Rest API request failed with error: %s\" % resp_json['message_list'][0]['message'])\n        except Exception:\n            print(resp)\n            raise RestUtilException(\"Rest API request failed : %s\" % resp.content)\n\ndef _do_get(url, cookies=None, params=None, auth=None, timeout=120):\n    try:\n        session = RestUtil(BASE_URL).get_session()\n        headers = {'Content-Type': 'application/json'}\n        for i in range(3):\n            resp = session.get(url, params=params,\n                            auth=_auth(), timeout=timeout,\n                            headers=headers,cookies=cookies, verify=False)\n            if resp.status_code in [500] :\n                time.sleep(30)\n            else:\n                break\n        return _wrap(resp),resp\n    except Exception:\n        print(\"Rest API GET request failed\")\n        raise\n\ndef _do_post(url,params=None, cookies=None,auth=None, timeout=120):\n    try:\n        session = RestUtil(BASE_URL).get_session()\n        headers = {'Content-Type': 'application/json'}\n        for i in range(3):\n            resp = session.post(url, data=json.dumps(params),\n                            auth=_auth(), timeout=timeout,\n                            headers=headers, cookies=cookies, verify=False)\n            if resp.status_code in [500]:\n                time.sleep(30)\n            else:\n                break\n        return _wrap(resp),resp\n    except Exception:\n        print(\"Rest API POST request failed\")\n        raise\n\ndef _get_session(server):\n    http_req_adapter = requests.adapters.HTTPAdapter(max_retries=3, pool_maxsize=30, pool_connections=1)\n    s = requests.Session()\n    s.mount(server, http_req_adapter)\n    return s\n\nclass RestUtil(object):\n    __instance = None\n    def __new__(cls, server):\n        if RestUtil.__instance is None:\n            RestUtil.__instance = object.__new__(cls)\n        RestUtil.__instance.session = _get_session(server)\n        return RestUtil.__instance\n\n    def get_session(self):\n        return self.session\n\ndef _v3_api_url(path):\n    return BASE_URL+path\n\ndef _v2_api_url(path):\n    return BASE_URL+'/api/nutanix/v2'+path\n\ndef _auth():\n    return (USER_NAME, PASSWORD)\n\ndef connect(url, user_name, password):\n    global BASE_URL, USER_NAME, PASSWORD\n    BASE_URL = url\n    USER_NAME = user_name\n    PASSWORD = password\n    _s = RestUtil(url)\n\ndef main():\n    _url = _v3_api_url\n    \n    create_path = \"/oss/api/nutanix/v3/objectstores/{}/buckets\".format(object_store_uuid)\n    create_payload = {\n        \"api_version\": \"3.0\",\n        \"metadata\": {\n            \"kind\": \"bucket\"\n        },\n        \"spec\": {\n            \"description\": \"\",\n            \"name\": bucket_name,\n            \"resources\": {\n                \"features\": [\n                ]\n            }\n        }\n    }\n\n    if enable_versioning:\n        create_payload[\"spec\"][\"resources\"][\"features\"].append(VERSIONING_FEATURE)\n    if non_current_version_expiration or expiration:\n        create_payload[\"spec\"][\"resources\"][\"lifecycle_configuration\"] = {\n            \"Rule\": [\n                {\n                    \"Filter\": {\n                    },\n                    \"ID\": \"ntnx-frontend-emptyprefix-rule\",\n                    \"Status\": \"Enabled\"\n                }\n            ]\n        }\n        if non_current_version_expiration:\n            create_payload[\"spec\"][\"resources\"][\"lifecycle_configuration\"][\"Rule\"][0][\"NoncurrentVersionExpiration\"] = {\"NoncurrentDays\": non_current_version_expiration}\n        if expiration:\n            create_payload[\"spec\"][\"resources\"][\"lifecycle_configuration\"][\"Rule\"][0][\"Expiration\"] = {\"Days\": expiration}\n\n    json_resp, resp = _do_post(_url(create_path), create_payload)\n\n    status_path = \"/oss/api/nutanix/v3/objectstores/{}/buckets/{}\".format(object_store_uuid, bucket_name)\n    bucket_create_pending = True\n    while bucket_create_pending:\n        json_resp, resp = _do_get(_url(status_path))\n        if json_resp[\"status\"][\"state\"] == 'COMPLETE':\n            bucket_create_pending = False\n            print(\"Bucket '{}' creation is Completed.\".format(bucket_name))\n            break\n        else:\n            print(\"Bucket creation '{}' is in '{}' state.\".format(bucket_name, json_resp[\"status\"][\"state\"]))\n            time.sleep(30)\n\nif __name__ == '__main__':\n    main()"
      },
      "variable_list": []
    },
    "description": ""
  },
  "spec": {
    "name": "create_bucket",
    "resources": {
      "type": "EXEC",
      "attrs": {
        "script": "import requests\nimport json\nimport re\nimport time\nimport sys\nfrom requests.packages.urllib3.exceptions import InsecureRequestWarning\n\nrequests.packages.urllib3.disable_warnings(InsecureRequestWarning)\n\npcip = \"10.0.0.1\"\nUSER_NAME = \"admin\"\nPASSWORD = \"xxxxxxx\"\n\nBASE_URL = \"https://\"+pcip+\":9440\"\nVERSIONING_FEATURE = \"VERSIONING\"\n\nobject_store_uuid = \"a646eee3-0c43-4a09-5205-bb9525a8d4a5\"\nbucket_name = \"calm-objects-bucket5\"\nenable_versioning = False\nnon_current_version_expiration = None #days\nexpiration = None #days\n\nclass RestUtilException(Exception):\n    pass\n\ndef _wrap(resp):\n    if resp.status_code in [200, 202]:\n        return resp.json()\n    else:\n        try:\n            resp_json = resp.json()\n            if 'message_list' in resp_json:\n                raise RestUtilException(\"Rest API request failed with error: %s\" % resp_json['message_list'][0]['message'])\n        except Exception:\n            print(resp)\n            raise RestUtilException(\"Rest API request failed : %s\" % resp.content)\n\ndef _do_get(url, cookies=None, params=None, auth=None, timeout=120):\n    try:\n        session = RestUtil(BASE_URL).get_session()\n        headers = {'Content-Type': 'application/json'}\n        for i in range(3):\n            resp = session.get(url, params=params,\n                            auth=_auth(), timeout=timeout,\n                            headers=headers,cookies=cookies, verify=False)\n            if resp.status_code in [500] :\n                time.sleep(30)\n            else:\n                break\n        return _wrap(resp),resp\n    except Exception:\n        print(\"Rest API GET request failed\")\n        raise\n\ndef _do_post(url,params=None, cookies=None,auth=None, timeout=120):\n    try:\n        session = RestUtil(BASE_URL).get_session()\n        headers = {'Content-Type': 'application/json'}\n        for i in range(3):\n            resp = session.post(url, data=json.dumps(params),\n                            auth=_auth(), timeout=timeout,\n                            headers=headers, cookies=cookies, verify=False)\n            if resp.status_code in [500]:\n                time.sleep(30)\n            else:\n                break\n        return _wrap(resp),resp\n    except Exception:\n        print(\"Rest API POST request failed\")\n        raise\n\ndef _get_session(server):\n    http_req_adapter = requests.adapters.HTTPAdapter(max_retries=3, pool_maxsize=30, pool_connections=1)\n    s = requests.Session()\n    s.mount(server, http_req_adapter)\n    return s\n\nclass RestUtil(object):\n    __instance = None\n    def __new__(cls, server):\n        if RestUtil.__instance is None:\n            RestUtil.__instance = object.__new__(cls)\n        RestUtil.__instance.session = _get_session(server)\n        return RestUtil.__instance\n\n    def get_session(self):\n        return self.session\n\ndef _v3_api_url(path):\n    return BASE_URL+path\n\ndef _v2_api_url(path):\n    return BASE_URL+'/api/nutanix/v2'+path\n\ndef _auth():\n    return (USER_NAME, PASSWORD)\n\ndef connect(url, user_name, password):\n    global BASE_URL, USER_NAME, PASSWORD\n    BASE_URL = url\n    USER_NAME = user_name\n    PASSWORD = password\n    _s = RestUtil(url)\n\ndef main():\n    _url = _v3_api_url\n    \n    create_path = \"/oss/api/nutanix/v3/objectstores/{}/buckets\".format(object_store_uuid)\n    create_payload = {\n        \"api_version\": \"3.0\",\n        \"metadata\": {\n            \"kind\": \"bucket\"\n        },\n        \"spec\": {\n            \"description\": \"\",\n            \"name\": bucket_name,\n            \"resources\": {\n                \"features\": [\n                ]\n            }\n        }\n    }\n\n    if enable_versioning:\n        create_payload[\"spec\"][\"resources\"][\"features\"].append(VERSIONING_FEATURE)\n    if non_current_version_expiration or expiration:\n        create_payload[\"spec\"][\"resources\"][\"lifecycle_configuration\"] = {\n            \"Rule\": [\n                {\n                    \"Filter\": {\n                    },\n                    \"ID\": \"ntnx-frontend-emptyprefix-rule\",\n                    \"Status\": \"Enabled\"\n                }\n            ]\n        }\n        if non_current_version_expiration:\n            create_payload[\"spec\"][\"resources\"][\"lifecycle_configuration\"][\"Rule\"][0][\"NoncurrentVersionExpiration\"] = {\"NoncurrentDays\": non_current_version_expiration}\n        if expiration:\n            create_payload[\"spec\"][\"resources\"][\"lifecycle_configuration\"][\"Rule\"][0][\"Expiration\"] = {\"Days\": expiration}\n\n    json_resp, resp = _do_post(_url(create_path), create_payload)\n\n    status_path = \"/oss/api/nutanix/v3/objectstores/{}/buckets/{}\".format(object_store_uuid, bucket_name)\n    bucket_create_pending = True\n    while bucket_create_pending:\n        json_resp, resp = _do_get(_url(status_path))\n        if json_resp[\"status\"][\"state\"] == 'COMPLETE':\n            bucket_create_pending = False\n            print(\"Bucket '{}' creation is Completed.\".format(bucket_name))\n            break\n        else:\n            print(\"Bucket creation '{}' is in '{}' state.\".format(bucket_name, json_resp[\"status\"][\"state\"]))\n            time.sleep(30)\n\nif __name__ == '__main__':\n    main()",
        "script_type": "static"
      },
      "variable_list": []
    },
    "description": ""
  },
  "api_version": "3.0",
  "metadata": {
    "last_update_time": "1672150063307688",
    "kind": "app_task",
    "uuid": "0545fe5f-76c9-4ba5-ae10-112989e477c5",
    "owner_reference": {
      "kind": "user",
      "uuid": "f770294b-960c-5b8d-9e5b-1441b339aff7",
      "name": "alain.veuve@emeagso.lab"
    },
    "spec_version": 0,
    "creation_time": "1672150063307688",
    "name": "create_bucket"
  }
}
