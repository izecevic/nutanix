{
  "status": {
    "state": "ACTIVE",
    "message_list": [],
    "name": "Router_Install_and_Configure",
    "resources": {
      "project_reference_list": [
        {
          "kind": "project",
          "uuid": "d64d5488-1f58-423c-b176-5c8b871f25a4",
          "name": "alain_client1"
        }
      ],
      "type": "EXEC",
      "attrs": {
        "script_type": "static",
        "type": "",
        "command_line_args": "",
        "exit_status": [],
        "script": "#!/bin/bash\nset -ex\n\n##  Variable Initialization\nPROFILE=\"@@{PROFILE}@@\"\nVERSION=\"@@{MONGO_VERSION}@@\"\nDATA_PATH=\"@@{DATA_PATH}@@\"\nJOURNAL_PATH=\"@@{JOURNAL_PATH}@@\"\nLOG_PATH=\"@@{LOG_PATH}@@\"\n\n\n## Set hostname\nsudo hostnamectl set-hostname --static @@{name}@@\n\n## Getting data ip and router ip addresses\nif [ \"x${PROFILE}\" = \"xAHV\" ]\nthen\n    CONFIG_IP_LIST=\"@@{AHVConfigSet.address}@@\"\n    DATA_IP_LIST=\"@@{AHVDataSet.address}@@\"\n    ROUTER_IP_LIST=\"@@{calm_array_address}@@\"\n    CONFIG_SRV_IPS=\"@@{AHVConfigSet.address}@@\"\n    REPLICA_IPS=($(echo @@{AHVDataSet.address}@@ | sed 's/^,//' | sed 's/,$//' | tr \",\" \"\\n\"))\n    INTERNAL_IP=\"@@{address}@@\"\nelif [ \"x${PROFILE}\" = \"xAWS\" ]\nthen\n    CONFIG_IP_LIST=\"@@{AWSConfigSet.private_ip_address}@@\"\n    DATA_IP_LIST=\"@@{AWSDataSet.private_ip_address}@@\"\n    ROUTER_IP_LIST=\"@@{calm_array_private_ip_address}@@\"\n    CONFIG_SRV_IPS=\"@@{AWSConfigSet.private_ip_address}@@\"\n    REPLICA_IPS=($(echo @@{AWSDataSet.private_ip_address}@@ | sed 's/^,//' | sed 's/,$//' | tr \",\" \"\\n\"))\n    INTERNAL_IP=\"@@{private_ip_address}@@\"    \nelif [ \"x${PROFILE}\" = \"xGCP\" ]\nthen\n    CONFIG_IP_LIST=\"@@{GCPConfigSet.private_ip_address}@@\"\n    DATA_IP_LIST=\"@@{GCPDataSet.private_ip_address}@@\" \n    ROUTER_IP_LIST=\"@@{calm_array_private_ip_address}@@\"\n    CONFIG_SRV_IPS=\"@@{GCPConfigSet.private_ip_address}@@\"\n    REPLICA_IPS=($(echo @@{GCPDataSet.private_ip_address}@@ | sed 's/^,//' | sed 's/,$//' | tr \",\" \"\\n\"))\n    INTERNAL_IP=\"@@{private_ip_address}@@\"    \nelif [ \"x${PROFILE}\" = \"xAZURE\" ]\nthen\n    CONFIG_IP_LIST=\"@@{AzureConfigSet.private_ip_address}@@\"\n    DATA_IP_LIST=\"@@{AzureDataSet.private_ip_address}@@\" \n    ROUTER_IP_LIST=\"@@{calm_array_private_ip_address}@@\"\n    CONFIG_SRV_IPS=\"@@{AzureConfigSet.private_ip_address}@@\"\n    REPLICA_IPS=($(echo @@{AzureDataSet.private_ip_address}@@ | sed 's/^,//' | sed 's/,$//' | tr \",\" \"\\n\"))\n    INTERNAL_IP=\"@@{private_ip_address}@@\"    \nelif [ \"x${PROFILE}\" = \"xVMWARE\" ]\nthen\n    CONFIG_IP_LIST=\"@@{VMwareConfigSet.address}@@\"\n    DATA_IP_LIST=\"@@{VMwareDataSet.address}@@\" \n    ROUTER_IP_LIST=\"@@{calm_array_address}@@\"\n    CONFIG_SRV_IPS=\"@@{VMwareConfigSet.address}@@\"\n    REPLICA_IPS=($(echo @@{VMwareDataSet.address}@@ | sed 's/^,//' | sed 's/,$//' | tr \",\" \"\\n\"))\n    INTERNAL_IP=\"@@{address}@@\"    \nfi\n\nNODES_PER_REPLICA_SET=\"@@{NODES_PER_REPLICA_SET}@@\"\nnoOfShards=$((${#REPLICA_IPS[@]}/${NODES_PER_REPLICA_SET}))\nconfig_ips=$(echo \"${CONFIG_SRV_IPS}\" | sed 's/^,//' | sed 's/,$//' | sed 's/,/:27017,/g')\nconfig_ips=$config_ips\":27017\"\n\n## Update hosts file \ncat > /tmp/set-hostnames.py <<EOF\n#!/usr/bin/python\nimport re\nconfig_ips=\"${CONFIG_IP_LIST}\"\ndata_ips=\"${DATA_IP_LIST}\"\nrouter_ips=\"${ROUTER_IP_LIST}\"\n\nhostfile = open('/etc/hosts', 'r').read()\nprint hostfile\nhostfile = re.sub('\\n#MONGODB-BEGIN.*?#MONGODB-END', '', hostfile, flags=re.DOTALL)\nhostfile += \"#MONGODB-BEGIN\\n\"\ncount=1\nfor ip in config_ips.split(','):\n  hostfile += ip + \" config\" + str(count) + \".mongodb\\n\"\n  count += 1\ncount=1\nfor ip in data_ips.split(','):\n  hostfile += ip + \" data\" + str(count) + \".mongodb\\n\"\n  count += 1\ncount=1\nfor ip in router_ips.split(','):\n  hostfile += ip + \" router\" + str(count) + \".mongodb\\n\"\n  count += 1\nhostfile += \"#MONGODB-END\\n\"\nopen('/etc/hosts', 'w').write(hostfile)\nEOF\n\nsudo python /tmp/set-hostnames.py\n\n## Update system params\nif [[ -f /sys/kernel/mm/transparent_hugepage/enabled ]];then\n\techo never | sudo tee /sys/kernel/mm/transparent_hugepage/enabled\nfi\nif [[ -f /sys/kernel/mm/transparent_hugepage/defrag ]];then\n\techo never | sudo tee /sys/kernel/mm/transparent_hugepage/defrag\nfi\n\n## Disable SELinux\nsudo sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/sysconfig/selinux\nsudo sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config\nsudo setenforce 0\n\n## Configure mongod yum repo\necho '[mongodb-org-3.4]\nname=MongoDB Repository\nbaseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/\ngpgcheck=1\nenabled=1\ngpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc' | sudo tee /etc/yum.repos.d/mongodb-3.4.repo\n\n## Install mongod\nsudo yum update -y --quiet\nsudo yum install -y --quiet mongodb-org-${VERSION} mongodb-org-server-${VERSION} mongodb-org-shell-${VERSION} mongodb-org-mongos-${VERSION} mongodb-org-tools-${VERSION}\n\necho 'exclude=mongodb-org*' | sudo tee -a /etc/yum.conf\n\nsudo mkdir -p ${DATA_PATH} ${JOURNAL_PATH} ${LOG_PATH}\nsudo ln -s ${JOURNAL_PATH} ${DATA_PATH}/journal\nsudo chown -R mongod:mongod ${DATA_PATH} ${JOURNAL_PATH} ${LOG_PATH}\n\n## Configure mongod conf\nsudo sed -i 's/bindIp:/#bindIp:/g' /etc/mongod.conf\nsudo sed -i \"s#/var/lib/mongo#${DATA_PATH}#g\" /etc/mongod.conf\n\n## Setup systemd conf for mongo service\necho \"[Unit]\nDescription=High-performance, schema-free document-oriented database\nAfter=network.target\nDocumentation=https://docs.mongodb.org/manual\n\n[Service]\nUser=mongod\nGroup=mongod\nEnvironment=\\\"OPTIONS=--port 27017 --configdb configReplSet/$config_ips --logpath /var/log/mongodb/mongos.log\\\"\nExecStart=/usr/bin/mongos \\$OPTIONS\nPermissionsStartOnly=true\nPIDFile=/var/run/mongodb/mongos.pid\n# file size\nLimitFSIZE=infinity\n# cpu time\nLimitCPU=infinity\n# virtual memory size\nLimitAS=infinity\n# open files\nLimitNOFILE=64000\n# processes/threads\nLimitNPROC=64000\n# total threads (user+kernel)\nTasksMax=infinity\nTasksAccounting=false\n# Recommended limits for for mongod as specified in\n# http://docs.mongodb.org/manual/reference/ulimit/#recommended-settings\n\n[Install]\nWantedBy=multi-user.target\" | sudo tee /usr/lib/systemd/system/mongos.service\n\nsudo systemctl start mongos\n#sudo -u mongod -b mongos --port 27017 --configdb  --logpath /var/log/mongodb/mongos.log \n\nsleep 2\n\ncount=0\nfor ((number=1;number <= $noOfShards;number++))\ndo\n  replicaSetName=\"dataReplSet${number}\"\n  sudo mongo --host ${INTERNAL_IP} --port 27017 --eval \"sh.addShard( \\\"$replicaSetName/${REPLICA_IPS[${count}]}:27017\\\" )\"\n  count=$(($count + ${NODES_PER_REPLICA_SET}))\ndone\n\n## Setting up mongos and mongod services\nsudo systemctl stop mongod\nsudo systemctl disable mongod\nsudo systemctl start mongos\nsudo systemctl enable mongos\nsleep 2"
      },
      "variable_list": []
    },
    "description": ""
  },
  "spec": {
    "name": "Router_Install_and_Configure",
    "resources": {
      "type": "EXEC",
      "attrs": {
        "script": "#!/bin/bash\nset -ex\n\n##  Variable Initialization\nPROFILE=\"@@{PROFILE}@@\"\nVERSION=\"@@{MONGO_VERSION}@@\"\nDATA_PATH=\"@@{DATA_PATH}@@\"\nJOURNAL_PATH=\"@@{JOURNAL_PATH}@@\"\nLOG_PATH=\"@@{LOG_PATH}@@\"\n\n\n## Set hostname\nsudo hostnamectl set-hostname --static @@{name}@@\n\n## Getting data ip and router ip addresses\nif [ \"x${PROFILE}\" = \"xAHV\" ]\nthen\n    CONFIG_IP_LIST=\"@@{AHVConfigSet.address}@@\"\n    DATA_IP_LIST=\"@@{AHVDataSet.address}@@\"\n    ROUTER_IP_LIST=\"@@{calm_array_address}@@\"\n    CONFIG_SRV_IPS=\"@@{AHVConfigSet.address}@@\"\n    REPLICA_IPS=($(echo @@{AHVDataSet.address}@@ | sed 's/^,//' | sed 's/,$//' | tr \",\" \"\\n\"))\n    INTERNAL_IP=\"@@{address}@@\"\nelif [ \"x${PROFILE}\" = \"xAWS\" ]\nthen\n    CONFIG_IP_LIST=\"@@{AWSConfigSet.private_ip_address}@@\"\n    DATA_IP_LIST=\"@@{AWSDataSet.private_ip_address}@@\"\n    ROUTER_IP_LIST=\"@@{calm_array_private_ip_address}@@\"\n    CONFIG_SRV_IPS=\"@@{AWSConfigSet.private_ip_address}@@\"\n    REPLICA_IPS=($(echo @@{AWSDataSet.private_ip_address}@@ | sed 's/^,//' | sed 's/,$//' | tr \",\" \"\\n\"))\n    INTERNAL_IP=\"@@{private_ip_address}@@\"    \nelif [ \"x${PROFILE}\" = \"xGCP\" ]\nthen\n    CONFIG_IP_LIST=\"@@{GCPConfigSet.private_ip_address}@@\"\n    DATA_IP_LIST=\"@@{GCPDataSet.private_ip_address}@@\" \n    ROUTER_IP_LIST=\"@@{calm_array_private_ip_address}@@\"\n    CONFIG_SRV_IPS=\"@@{GCPConfigSet.private_ip_address}@@\"\n    REPLICA_IPS=($(echo @@{GCPDataSet.private_ip_address}@@ | sed 's/^,//' | sed 's/,$//' | tr \",\" \"\\n\"))\n    INTERNAL_IP=\"@@{private_ip_address}@@\"    \nelif [ \"x${PROFILE}\" = \"xAZURE\" ]\nthen\n    CONFIG_IP_LIST=\"@@{AzureConfigSet.private_ip_address}@@\"\n    DATA_IP_LIST=\"@@{AzureDataSet.private_ip_address}@@\" \n    ROUTER_IP_LIST=\"@@{calm_array_private_ip_address}@@\"\n    CONFIG_SRV_IPS=\"@@{AzureConfigSet.private_ip_address}@@\"\n    REPLICA_IPS=($(echo @@{AzureDataSet.private_ip_address}@@ | sed 's/^,//' | sed 's/,$//' | tr \",\" \"\\n\"))\n    INTERNAL_IP=\"@@{private_ip_address}@@\"    \nelif [ \"x${PROFILE}\" = \"xVMWARE\" ]\nthen\n    CONFIG_IP_LIST=\"@@{VMwareConfigSet.address}@@\"\n    DATA_IP_LIST=\"@@{VMwareDataSet.address}@@\" \n    ROUTER_IP_LIST=\"@@{calm_array_address}@@\"\n    CONFIG_SRV_IPS=\"@@{VMwareConfigSet.address}@@\"\n    REPLICA_IPS=($(echo @@{VMwareDataSet.address}@@ | sed 's/^,//' | sed 's/,$//' | tr \",\" \"\\n\"))\n    INTERNAL_IP=\"@@{address}@@\"    \nfi\n\nNODES_PER_REPLICA_SET=\"@@{NODES_PER_REPLICA_SET}@@\"\nnoOfShards=$((${#REPLICA_IPS[@]}/${NODES_PER_REPLICA_SET}))\nconfig_ips=$(echo \"${CONFIG_SRV_IPS}\" | sed 's/^,//' | sed 's/,$//' | sed 's/,/:27017,/g')\nconfig_ips=$config_ips\":27017\"\n\n## Update hosts file \ncat > /tmp/set-hostnames.py <<EOF\n#!/usr/bin/python\nimport re\nconfig_ips=\"${CONFIG_IP_LIST}\"\ndata_ips=\"${DATA_IP_LIST}\"\nrouter_ips=\"${ROUTER_IP_LIST}\"\n\nhostfile = open('/etc/hosts', 'r').read()\nprint hostfile\nhostfile = re.sub('\\n#MONGODB-BEGIN.*?#MONGODB-END', '', hostfile, flags=re.DOTALL)\nhostfile += \"#MONGODB-BEGIN\\n\"\ncount=1\nfor ip in config_ips.split(','):\n  hostfile += ip + \" config\" + str(count) + \".mongodb\\n\"\n  count += 1\ncount=1\nfor ip in data_ips.split(','):\n  hostfile += ip + \" data\" + str(count) + \".mongodb\\n\"\n  count += 1\ncount=1\nfor ip in router_ips.split(','):\n  hostfile += ip + \" router\" + str(count) + \".mongodb\\n\"\n  count += 1\nhostfile += \"#MONGODB-END\\n\"\nopen('/etc/hosts', 'w').write(hostfile)\nEOF\n\nsudo python /tmp/set-hostnames.py\n\n## Update system params\nif [[ -f /sys/kernel/mm/transparent_hugepage/enabled ]];then\n\techo never | sudo tee /sys/kernel/mm/transparent_hugepage/enabled\nfi\nif [[ -f /sys/kernel/mm/transparent_hugepage/defrag ]];then\n\techo never | sudo tee /sys/kernel/mm/transparent_hugepage/defrag\nfi\n\n## Disable SELinux\nsudo sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/sysconfig/selinux\nsudo sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config\nsudo setenforce 0\n\n## Configure mongod yum repo\necho '[mongodb-org-3.4]\nname=MongoDB Repository\nbaseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/\ngpgcheck=1\nenabled=1\ngpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc' | sudo tee /etc/yum.repos.d/mongodb-3.4.repo\n\n## Install mongod\nsudo yum update -y --quiet\nsudo yum install -y --quiet mongodb-org-${VERSION} mongodb-org-server-${VERSION} mongodb-org-shell-${VERSION} mongodb-org-mongos-${VERSION} mongodb-org-tools-${VERSION}\n\necho 'exclude=mongodb-org*' | sudo tee -a /etc/yum.conf\n\nsudo mkdir -p ${DATA_PATH} ${JOURNAL_PATH} ${LOG_PATH}\nsudo ln -s ${JOURNAL_PATH} ${DATA_PATH}/journal\nsudo chown -R mongod:mongod ${DATA_PATH} ${JOURNAL_PATH} ${LOG_PATH}\n\n## Configure mongod conf\nsudo sed -i 's/bindIp:/#bindIp:/g' /etc/mongod.conf\nsudo sed -i \"s#/var/lib/mongo#${DATA_PATH}#g\" /etc/mongod.conf\n\n## Setup systemd conf for mongo service\necho \"[Unit]\nDescription=High-performance, schema-free document-oriented database\nAfter=network.target\nDocumentation=https://docs.mongodb.org/manual\n\n[Service]\nUser=mongod\nGroup=mongod\nEnvironment=\\\"OPTIONS=--port 27017 --configdb configReplSet/$config_ips --logpath /var/log/mongodb/mongos.log\\\"\nExecStart=/usr/bin/mongos \\$OPTIONS\nPermissionsStartOnly=true\nPIDFile=/var/run/mongodb/mongos.pid\n# file size\nLimitFSIZE=infinity\n# cpu time\nLimitCPU=infinity\n# virtual memory size\nLimitAS=infinity\n# open files\nLimitNOFILE=64000\n# processes/threads\nLimitNPROC=64000\n# total threads (user+kernel)\nTasksMax=infinity\nTasksAccounting=false\n# Recommended limits for for mongod as specified in\n# http://docs.mongodb.org/manual/reference/ulimit/#recommended-settings\n\n[Install]\nWantedBy=multi-user.target\" | sudo tee /usr/lib/systemd/system/mongos.service\n\nsudo systemctl start mongos\n#sudo -u mongod -b mongos --port 27017 --configdb  --logpath /var/log/mongodb/mongos.log \n\nsleep 2\n\ncount=0\nfor ((number=1;number <= $noOfShards;number++))\ndo\n  replicaSetName=\"dataReplSet${number}\"\n  sudo mongo --host ${INTERNAL_IP} --port 27017 --eval \"sh.addShard( \\\"$replicaSetName/${REPLICA_IPS[${count}]}:27017\\\" )\"\n  count=$(($count + ${NODES_PER_REPLICA_SET}))\ndone\n\n## Setting up mongos and mongod services\nsudo systemctl stop mongod\nsudo systemctl disable mongod\nsudo systemctl start mongos\nsudo systemctl enable mongos\nsleep 2",
        "script_type": "static"
      },
      "variable_list": []
    },
    "description": ""
  },
  "api_version": "3.0",
  "metadata": {
    "last_update_time": "1672150034239725",
    "kind": "app_task",
    "uuid": "1e8c47e9-7034-40b0-94ac-c4ae6667a653",
    "owner_reference": {
      "kind": "user",
      "uuid": "f770294b-960c-5b8d-9e5b-1441b339aff7",
      "name": "alain.veuve@emeagso.lab"
    },
    "spec_version": 0,
    "creation_time": "1672150034239725",
    "name": "Router_Install_and_Configure"
  }
}
