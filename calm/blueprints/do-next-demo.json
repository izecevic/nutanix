{"status":{},"spec":{"description":"n-tier Web Stack blueprint\nwith slack notification, cloudflare monitoring and edge LB integration\nk8s integration","resources":{"client_attrs":{"8f15d01b-01ae-4c50-a2ef-7bdf8569c347":{"y":-149.4285714286,"x":154.1428571429},"4d143240-6ef1-4a8c-a6ff-45b2f336480e":{"y":45.7142857143,"x":-39.2857142857},"3c3a6caf-8281-4108-abcc-2cc182f70e35":{"y":-149.4285714286,"x":154.1428571429},"c41b06ec-1344-4d18-8a0e-bf68c392caaf":{"y":313.7142857143,"x":-546.7142857143},"DEPLOY":{"y":58.4285692487,"x":-136.9642944336},"4672fa2e-0abe-4e42-bff9-fb86bb064143":{"y":45.7142857143,"x":-39.2857142857},"cbc66a9b_deployment":{"y":202.8571428572,"x":-417.5714285714},"None":{"y":140,"x":1220},"5857018a_deployment":{"y":18.4285714286,"x":135},"7ef93cc1-21eb-4b1a-9689-3bbbc7c2c66e":{"y":313.7142857143,"x":-546.7142857143},"69d684c5-89f4-4672-9979-90348a868d77":{"y":45.7142857143,"x":-39.2857142857},"a1172002-f98e-4732-b5a0-588f4b682398":{"y":-149.4285714286,"x":154.1428571429},"f04e4ccb-1de9-49f8-b3c9-a7dfcd44d8af":{"y":-82.5714285714,"x":441.2857142857},"e775fc75-9a56-47b4-b1a2-f4b9c19aa0f4":{"y":-82.5714285714,"x":441.2857142857}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"614e22c6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"55798d8c_runbook","main_task_local_reference":{"kind":"app_task","name":"614e22c6_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"7d839765_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"631cf0ea_runbook","main_task_local_reference":{"kind":"app_task","name":"7d839765_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"075e4b33_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"68b3c509_runbook","main_task_local_reference":{"kind":"app_task","name":"075e4b33_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"c857778e_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"94704c3b_runbook","main_task_local_reference":{"kind":"app_task","name":"c857778e_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"mongo"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"e9e7d2d3_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"65ac9163_runbook","main_task_local_reference":{"kind":"app_task","name":"e9e7d2d3_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"mongo","port_list":[],"tier":"","variable_list":[],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"external"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"configure DNS"},{"kind":"app_task","name":"set traefik"},{"kind":"app_task","name":"add monitor"},{"kind":"app_task","name":"notify slack"}],"name":"80c04b4c_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"configure DNS"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"set traefik"}},{"from_task_reference":{"kind":"app_task","name":"set traefik"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"add monitor"}},{"from_task_reference":{"kind":"app_task","name":"add monitor"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"notify slack"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"external"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"configure DNS","attrs":{"exit_status":[],"script":"#script\n\nheaders = {'Content-Type': 'application\/json', 'X-Auth-Email': '@@{CLOUDFLARE_API_EMAIL}@@', 'X-Auth-Key': '@@{CLOUDFLARE_API_KEY}@@'}\napi_url = \"https:\/\/api.cloudflare.com\/client\/v4\/zones\/@@{CLOUDFLARE_ZONE}@@\/dns_records\"\nname = \"@@{calm_application_name}@@\"\n\n\npayload = {\n\t'type':'A',\n\t'name': name.replace(\" \", \"-\").replace(\"_\",\"-\") + '.nxlab.fr',\n\t'content':'195.68.123.25'\n}\n\nr = urlreq(api_url, verb='POST', headers=headers, params=json.dumps(payload))\n \nif r.ok:\n  print r.content\n  reponse = json.loads(r.content)\n  print 'record_id=%s' % reponse['result']['id']\nelse:\n  print \"Post request failed\", r.content\n  exit(1)\n","eval_variables":["record_id","svc_ip"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"external"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"set traefik","attrs":{"exit_status":[],"script":"app_name=\"@@{calm_application_name}@@\"\napp_name=${app_name\/ \/-}\napp_name=${app_name\/_\/-}\n\ncat << EOF | tee \/etc\/traefik\/traefik.d\/$app_name.toml\n[backends]\n  [backends.$app_name]\n    [backends.$app_name.servers.server1]\n      url = \"http:\/\/@@{app_next_svc.ingress}@@\"\n      weight = 1\n    \n[frontends]\n  [frontends.$app_name]\n    entryPoints = [\"http\", \"https\"]\n    backend = \"$app_name\"\n    passHostHeader = true\n  [frontends.$app_name.routes.default]\n    rule = \"Host: $app_name.nxlab.fr\"\nEOF","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"traefik"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"external"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"add monitor","attrs":{"exit_status":[],"script":"#script\n\nheaders = {'Content-Type': 'application\/x-www-form-urlencoded'}\napi_url = \"https:\/\/api.uptimerobot.com\/v2\/newMonitor\"\nname = \"@@{calm_application_name}@@\".replace(\" \", \"-\").replace(\"_\",\"-\")\nurl = \"https:\/\/\" + name + \".nxlab.fr\/\"\n\npayload = \"api_key=@@{MONITOR_API_KEY}@@&format=json&type=1&url=\"+ url + \"&friendly_name=\" + name\n \n\nr = urlreq(api_url, verb='POST', headers=headers, params=payload)\n \nif r.ok:\n  print r.content\n  reponse = json.loads(r.content)\n  print 'monitor_id=%s' % reponse['monitor']['id']\nelse:\n  print \"Post request failed\", r.content\n  exit(1)","eval_variables":["monitor_id"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"external"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"notify slack","attrs":{"script":"#script\n\nheaders = {'Content-Type': 'application\/json'}\napi_url = \"@@{SLACK_HOOK}@@\"\nname = \"@@{calm_application_name}@@\"\nurl = name.replace(\" \", \"-\").replace(\"_\",\"-\") + \".nxlab.fr\"\n\n\npayload = {\n  'text': 'Server @@{calm_application_name}@@ was just deployed on the cluster by @@{calm_username}@@ <https:\/\/' + url + '\/|click here> to connect !\\n- Server was added to the monitoring system <https:\/\/status.nxlab.fr\/|here>\\n- Global Load Balancer dashboard <http:\/\/10.83.0.220:8080\/dashboard\/|here>'\n}\n\nr = urlreq(api_url, verb='POST', headers=headers, params=json.dumps(payload))\n \nif r.ok:\n  print r.content\nelse:\n  print \"Post request failed\", r.content\n  exit(1)\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"08836b20_runbook","main_task_local_reference":{"kind":"app_task","name":"80c04b4c_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"external"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"delete traefik"},{"kind":"app_task","name":"remove dns entry"},{"kind":"app_task","name":"remove monitor"}],"name":"290baa52_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"delete traefik"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"remove dns entry"}},{"from_task_reference":{"kind":"app_task","name":"remove dns entry"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"remove monitor"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"external"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"delete traefik","attrs":{"exit_status":[],"script":"app_name=\"@@{calm_application_name}@@\"\napp_name=${app_name\/ \/-}\napp_name=${app_name\/_\/-}\n\nrm \/etc\/traefik\/traefik.d\/$app_name.toml\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"traefik"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"external"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"remove dns entry","attrs":{"script":"#script\n\nheaders = {'Content-Type': 'application\/json', 'X-Auth-Email': '@@{CLOUDFLARE_API_EMAIL}@@', 'X-Auth-Key': '@@{CLOUDFLARE_API_KEY}@@'}\napi_url = \"https:\/\/api.cloudflare.com\/client\/v4\/zones\/@@{CLOUDFLARE_ZONE}@@\/dns_records\/@@{record_id}@@\"\n\n\nr = urlreq(api_url, verb='DELETE', headers=headers)\n \nif r.ok:\n  print r.content\nelse:\n  print \"Post request failed\", r.content\n  exit(1)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"external"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"remove monitor","attrs":{"script":"#script\n\nheaders = {'Content-Type': 'application\/x-www-form-urlencoded'}\napi_url = \"https:\/\/api.uptimerobot.com\/v2\/deleteMonitor\"\n\n\npayload = \"api_key=@@{MONITOR_API_KEY}@@&format=json&id=@@{monitor_id}@@\"\n \n\nr = urlreq(api_url, verb='POST', headers=headers, params=payload)\n \nif r.ok:\n  print r.content\nelse:\n  print \"Post request failed\", r.content\n  exit(1)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"291f8a1a_runbook","main_task_local_reference":{"kind":"app_task","name":"290baa52_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"external"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"7cdd8925_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"fc7c7448_runbook","main_task_local_reference":{"kind":"app_task","name":"7cdd8925_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"external"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"aa0d4d3f_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"ed16ef57_runbook","main_task_local_reference":{"kind":"app_task","name":"aa0d4d3f_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"external"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"43d00af9_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"5b2b1b4d_runbook","main_task_local_reference":{"kind":"app_task","name":"43d00af9_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"external","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","description":"","name":"record_id","type":"SECRET","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":""}},{"val_type":"STRING","description":"","name":"monitor_id","type":"SECRET","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":""}}],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"web_app_next"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"b8851521_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7c0cf464_runbook","main_task_local_reference":{"kind":"app_task","name":"b8851521_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"web_app_next"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"e24e47d6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"0f6f5599_runbook","main_task_local_reference":{"kind":"app_task","name":"e24e47d6_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"web_app_next"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"84144fb0_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"8da585c8_runbook","main_task_local_reference":{"kind":"app_task","name":"84144fb0_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"web_app_next"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"cf510e71_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"e771140a_runbook","main_task_local_reference":{"kind":"app_task","name":"cf510e71_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"web_app_next"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"9b20e7bd_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"50272695_runbook","main_task_local_reference":{"kind":"app_task","name":"9b20e7bd_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"web_app_next","port_list":[],"tier":"","container_spec":{"ports":[{"protocol":"TCP","containerPort":80}],"env":[{"name":"app_name","value":"@@{calm_application_name}@@"},{"name":"MONGO_SRV","value":"@@{mongo.address}@@"}],"name":"web-app-next"},"variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"EXISTING_VM","name":"MONGODB","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":true,"address":"@@{ip_address}@@","delay_secs":"0","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"CENTOS"}},"os_type":"Linux","create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"127.0.0.1"},"variable_list":[]},{"description":"","action_list":[],"type":"EXISTING_VM","name":"Traefik_svc","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":false,"address":"@@{ip_address}@@","delay_secs":"0","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"traefik"}},"os_type":"Linux","create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"10.83.0.220"},"variable_list":[]},{"description":"","action_list":[],"type":"K8S_POD","name":"APP","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":false,"address":"","delay_secs":"60","connection_port":22},"os_type":"Linux","create_spec":{"metadata":{"labels":{"app":"app-@@{calm_application_name}@@"},"namespace":"default","name":"web-app-next"},"type":"PROVISION_K8S_POD","spec":{"restartPolicy":"Always"},"account_uuid":"d22c0fd5-9832-eb39-4811-c355f5d469b5"},"variable_list":[]}],"credential_definition_list":[{"username":"centos","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"CENTOS","editables":{"username":true,"secret":true}},{"username":"root","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"traefik"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"mongo"}],"name":"MONGODB_PACKAGE","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"MONGODB_PACKAGE"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"696811b8_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"fa139f70_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"696811b8_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"MONGODB_PACKAGE"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"9f5b6937_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"add53bd1_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"9f5b6937_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"external"}],"name":"Package7","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package7"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"92cc24c6_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"6c44bd99_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"92cc24c6_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package7"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"757a7a71_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"247713f7_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"757a7a71_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"image_spec":{"image":"@@{container_app}@@","imagePullPolicy":"Always"},"description":"","action_list":[],"type":"K8S_IMAGE","service_local_reference_list":[{"kind":"app_service","name":"web_app_next"}],"name":"Package3","version":"","variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"cbc66a9b_deployment","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"MONGODB_PACKAGE"}],"substrate_local_reference":{"kind":"app_substrate","name":"MONGODB"},"min_replicas":"1","variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"5857018a_deployment","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package7"}],"substrate_local_reference":{"kind":"app_substrate","name":"Traefik_svc"},"min_replicas":"1","variable_list":[],"description":""},{"type":"K8S_DEPLOYMENT","action_list":[],"depends_on_list":[],"name":"DEPLOY","published_service_local_reference_list":[{"kind":"app_published_service","name":"app_next_svc"}],"max_replicas":"100","package_local_reference_list":[{"kind":"app_package","name":"Package3"}],"substrate_local_reference":{"kind":"app_substrate","name":"APP"},"min_replicas":"2","options":{"type":"PROVISION_K8S_DEPLOYMENT","spec":{"selector":{"matchLabels":{"app":"app-@@{calm_application_name}@@"}},"replicas":"2"},"metadata":{"namespace":"default","name":"app-next"}},"variable_list":[],"description":""}],"description":"","action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"change image"},{"kind":"app_task","name":"notification"}],"name":"694258f9_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"change image"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"notification"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"external"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"change image","attrs":{"script":"\nheaders = {'Authorization':'Bearer @@{k8s_token}@@', 'Content-Type': 'application\/json'}\napi_url = \"https:\/\/10.83.0.110:443\/apis\/apps\/v1\/namespaces\/default\/deployments\/@@{DEPLOY.name}@@\"\n\nr = urlreq(api_url, verb='GET', headers=headers)\n \nif r.ok:\n  print r.content\n  deployment = json.loads(r.content)\nelse:\n  print \"Post request failed\", r.content\n  exit(1)\n\ndeployment['spec']['template']['spec']['containers'][0]['image'] = \"@@{image}@@\"\n  \nheaders = {'Authorization':'Bearer @@{k8s_token}@@', 'Content-Type': 'application\/merge-patch+json'}\n\nr = urlreq(api_url, verb='PATCH', headers=headers, params=json.dumps(deployment))\n\nif r.ok:\n  print r.content\nelse:\n  print \"Post request failed\", r.content\n  exit(1)\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"external"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"notification","attrs":{"script":"#script\n\nheaders = {'Content-Type': 'application\/json'}\napi_url = \"@@{SLACK_HOOK}@@\"\nname = \"@@{calm_application_name}@@\"\nurl = name.replace(\" \", \"-\").replace(\"_\",\"-\") + \".nxlab.fr\"\n\n\npayload = {\n  'text': 'Server @@{calm_application_name}@@ container image was just replaced by `@@{image}@@`'\n}\n\nr = urlreq(api_url, verb='POST', headers=headers, params=json.dumps(payload))\n \nif r.ok:\n  print r.content\nelse:\n  print \"Post request failed\", r.content\n  exit(1)\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"3ca5b7e1_runbook","main_task_local_reference":{"kind":"app_task","name":"694258f9_dag"},"variable_list":[{"val_type":"STRING","description":"","name":"image","type":"LOCAL","value":"${ARTEFACT_PATH} ex tuxtof\/web-server:new","label":"","attrs":{"type":""},"editables":{"value":true}}]},"name":"Upgrade App"}],"name":"AHV","variable_list":[{"val_type":"STRING","description":"","name":"container_app","type":"LOCAL","value":"registry.gitlab.com\/tuxtof\/nutanix-web-next","label":"","editables":{"value":true}},{"val_type":"STRING","description":"","name":"CLOUDFLARE_API_KEY","type":"SECRET","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":""}},{"val_type":"STRING","description":"","name":"CLOUDFLARE_API_EMAIL","type":"SECRET","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":""}},{"val_type":"STRING","description":"","name":"CLOUDFLARE_ZONE","type":"SECRET","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":""}},{"val_type":"STRING","description":"","name":"SLACK_HOOK","type":"SECRET","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":""}},{"val_type":"STRING","description":"","name":"MYSQL_PASSWORD","type":"SECRET","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":""}},{"val_type":"STRING","description":"","name":"INSTANCE_PUBLIC_KEY","type":"LOCAL","value":"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDECpYfCllea7A+4zp3N87i8NSix46WTFq9ub47Y56d6JaoncYoh1VE+EyAGKyVTbqRgWFJpF8QpocUCWK4uBhiO8+0fJe33157IbS2i3IEXkCg7\/bOPxNcXo7vpOqEv0dV\/FKufeOtczyeqYC0XzKZVw9oMT9hzxj341BU+cBQz05xUJ729Y5PMTOGFxttQQuH0HACWmrWikfzQ8OKOrfg7lGo32aV1rI4M6NKn1MVgrAYs+ArZyS6TEXL2nttydnwMei1N1XGIUxV8QytkzIRWxsLV1eFuaavLepeRiHggVo2xJEpWo0L+AsLe5PzwwbdSQtAxaEfOMQaozXZJ\/vL cris@macpro.local","label":""},{"val_type":"STRING","description":"","name":"MONITOR_API_KEY","type":"SECRET","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":""}},{"val_type":"STRING","description":"","name":"k8s_token","type":"SECRET","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":""}}]}],"published_service_definition_list":[{"singleton":true,"action_list":[],"type":"K8S_SERVICE","depends_on_list":[],"name":"app_next_svc","port_list":[],"tier":"","options":{"type":"PROVISION_K8S_SERVICE","spec":{"type":"LoadBalancer","ports":[{"protocol":"TCP","targetPort":80,"name":"","port":80}],"selector":{"app":"app-@@{calm_application_name}@@"}},"metadata":{"labels":{},"namespace":"default","name":"app-next"}},"variable_list":[],"description":""}],"default_credential_local_reference":{"kind":"app_credential","name":"CENTOS"},"type":"USER"},"name":"dotNext_Demo"},"api_version":"3.0","metadata":{"last_update_time":"1547724604454390","kind":"blueprint","spec_version":15,"creation_time":"1542911172631019","name":"dotNext_Demo"}}
